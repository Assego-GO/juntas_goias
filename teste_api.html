<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Completo - Juntas Goi√°s</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .test-card {
            padding: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            background: #f9f9f9;
            transition: all 0.3s;
        }
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .test-card h3 {
            color: #764ba2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .resultado {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        .status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status.success { background: #4caf50; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.pending { background: #ff9800; color: white; }
        .status.loading { background: #2196F3; color: white; }
        
        .resumo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .resumo h2 { margin-bottom: 15px; }
        .stats {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-top: 20px;
        }
        .stat {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            flex: 1;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .action-bar {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .action-bar button {
            flex: 1;
            min-width: 200px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste Completo - Juntas Goi√°s</h1>
        <p class="subtitle">Valida√ß√£o completa de todas as APIs e funcionalidades</p>

        <!-- Resumo -->
        <div class="resumo">
            <h2>üìä Resumo dos Testes</h2>
            <div class="stats">
                <div class="stat">
                    <div class="stat-number" id="total-testes">6</div>
                    <div class="stat-label">Total de Testes</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="testes-sucesso">0</div>
                    <div class="stat-label">Sucessos</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="testes-erro">0</div>
                    <div class="stat-label">Erros</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="tempo-total">0s</div>
                    <div class="stat-label">Tempo Total</div>
                </div>
            </div>
        </div>

        <!-- A√ß√µes r√°pidas -->
        <div class="action-bar">
            <button onclick="executarTodos()" id="btn-todos">
                üöÄ Executar Todos os Testes
            </button>
            <button onclick="limparResultados()">
                üóëÔ∏è Limpar Resultados
            </button>
            <button onclick="exportarResultados()">
                üíæ Exportar Resultados
            </button>
        </div>

        <!-- Grid de testes -->
        <div class="grid">
            <!-- Teste 1: Munic√≠pios -->
            <div class="test-card">
                <h3>
                    üìç Munic√≠pios
                    <span id="status-1" class="status pending">Pendente</span>
                </h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    Lista todos os munic√≠pios de Goi√°s cadastrados
                </p>
                <button onclick="testar(1, testarMunicipios)">Executar</button>
                <div id="resultado-1" class="resultado"></div>
            </div>

            <!-- Teste 2: Categorias -->
            <div class="test-card">
                <h3>
                    üìÇ Categorias
                    <span id="status-2" class="status pending">Pendente</span>
                </h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    Lista todas as categorias de servi√ßos
                </p>
                <button onclick="testar(2, testarCategorias)">Executar</button>
                <div id="resultado-2" class="resultado"></div>
            </div>

            <!-- Teste 3: Servi√ßos por Munic√≠pio -->
            <div class="test-card">
                <h3>
                    üè¢ Servi√ßos (Goi√¢nia)
                    <span id="status-3" class="status pending">Pendente</span>
                </h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    Busca servi√ßos dispon√≠veis em Goi√¢nia
                </p>
                <button onclick="testar(3, testarServicosMunicipio)">Executar</button>
                <div id="resultado-3" class="resultado"></div>
            </div>

            <!-- Teste 4: DEAMs -->
            <div class="test-card">
                <h3>
                    üö® DEAMs
                    <span id="status-4" class="status pending">Pendente</span>
                </h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    Lista todas as Delegacias da Mulher
                </p>
                <button onclick="testar(4, testarDEAMs)">Executar</button>
                <div id="resultado-4" class="resultado"></div>
            </div>

            <!-- Teste 5: Criar Demanda -->
            <div class="test-card">
                <h3>
                    üìù Criar Demanda
                    <span id="status-5" class="status pending">Pendente</span>
                </h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    Testa cria√ß√£o de novo pedido de ajuda
                </p>
                <button onclick="testar(5, testarCriarDemanda)">Executar</button>
                <div id="resultado-5" class="resultado"></div>
            </div>

            <!-- Teste 6: Tipos de Viol√™ncia -->
            <div class="test-card">
                <h3>
                    ‚ö†Ô∏è Tipos de Viol√™ncia
                    <span id="status-6" class="status pending">Pendente</span>
                </h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    Lista os tipos de viol√™ncia cadastrados
                </p>
                <button onclick="testar(6, testarTiposViolencia)">Executar</button>
                <div id="resultado-6" class="resultado"></div>
            </div>
        </div>
    </div>

    <script>
        // Detectar caminho da API automaticamente
        //const API_BASE = window.location.origin + window.location.pathname.replace('teste-completo.html', '') + 'api';
        const API_BASE = '/layane/juntas_goias/api';
        
        console.log('üîó API Base:', API_BASE);

        let resultados = {
            total: 6,
            sucesso: 0,
            erro: 0,
            tempo: 0,
            detalhes: []
        };

        function atualizarResumo() {
            document.getElementById('testes-sucesso').textContent = resultados.sucesso;
            document.getElementById('testes-erro').textContent = resultados.erro;
            document.getElementById('tempo-total').textContent = resultados.tempo.toFixed(2) + 's';
        }

        function mostrarStatus(id, tipo, mensagem) {
            const status = document.getElementById(`status-${id}`);
            status.className = `status ${tipo}`;
            
            const icons = {
                loading: '<span class="loading-icon"></span>',
                success: '‚úÖ',
                error: '‚ùå',
                pending: '‚è≥'
            };
            
            status.innerHTML = `${icons[tipo]} ${mensagem}`;
        }

        function mostrarResultado(id, dados, sucesso) {
            const resultado = document.getElementById(`resultado-${id}`);
            resultado.style.display = 'block';
            
            if (typeof dados === 'object') {
                resultado.textContent = JSON.stringify(dados, null, 2);
            } else {
                resultado.textContent = dados;
            }
        }

        async function testar(id, funcao) {
            mostrarStatus(id, 'loading', 'Executando...');
            const inicio = performance.now();
            
            try {
                await funcao(id);
                const tempo = (performance.now() - inicio) / 1000;
                mostrarStatus(id, 'success', `${tempo.toFixed(2)}s`);
                resultados.sucesso++;
                resultados.detalhes.push({ id, sucesso: true, tempo });
            } catch (error) {
                mostrarStatus(id, 'error', 'Falhou');
                resultados.erro++;
                resultados.detalhes.push({ id, sucesso: false, erro: error.message });
            }
            
            atualizarResumo();
        }

        async function testarMunicipios(id) {
            const res = await fetch(`${API_BASE}/municipios.php`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            mostrarResultado(id, data, true);
            if (!data.data || data.data.length === 0) throw new Error('Nenhum munic√≠pio encontrado');
        }

        async function testarCategorias(id) {
            const res = await fetch(`${API_BASE}/servicos.php?acao=categorias`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            mostrarResultado(id, data, true);
            if (!data.data || data.data.length === 0) throw new Error('Nenhuma categoria encontrada');
        }

        async function testarServicosMunicipio(id) {
            const res = await fetch(`${API_BASE}/servicos.php?acao=por-municipio&municipio_id=1`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            mostrarResultado(id, data, true);
            if (!data.data || data.data.length === 0) throw new Error('Nenhum servi√ßo encontrado');
        }

        async function testarDEAMs(id) {
            const res = await fetch(`${API_BASE}/servicos.php?acao=deams`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            mostrarResultado(id, data, true);
            if (!data.data || data.data.length === 0) throw new Error('Nenhuma DEAM encontrada');
        }

        async function testarCriarDemanda(id) {
            const demanda = {
                municipio_id: 1,
                nome: "Teste Autom√°tico",
                telefone: "(62) 99999-9999",
                email: "teste@sistema.com",
                faixa_etaria: "25-34",
                situacao_moradia: "alugada",
                descricao: "Teste de integra√ß√£o da API",
                nivel_urgencia: "baixo",
                perigo_iminente: false,
                criancas_envolvidas: false,
                idosos_envolvidos: false,
                anonimo: true,
                tipos_violencia: [1, 2]
            };

            const res = await fetch(`${API_BASE}/demandas.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(demanda)
            });
            
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            mostrarResultado(id, data, true);
            if (data.status !== 'success') throw new Error(data.message);
        }

        async function testarTiposViolencia(id) {
            const res = await fetch(`${API_BASE}/tipos-violencia.php`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            mostrarResultado(id, data, true);
        }

        async function executarTodos() {
            const btn = document.getElementById('btn-todos');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-icon"></span> Executando...';
            
            resultados = { total: 6, sucesso: 0, erro: 0, tempo: 0, detalhes: [] };
            const inicioGeral = performance.now();
            
            for (let i = 1; i <= 6; i++) {
                const funcoes = [
                    null,
                    testarMunicipios,
                    testarCategorias,
                    testarServicosMunicipio,
                    testarDEAMs,
                    testarCriarDemanda,
                    testarTiposViolencia
                ];
                
                await testar(i, funcoes[i]);
                await new Promise(r => setTimeout(r, 300));
            }
            
            resultados.tempo = (performance.now() - inicioGeral) / 1000;
            atualizarResumo();
            
            btn.disabled = false;
            btn.innerHTML = 'üöÄ Executar Todos os Testes';
            
            if (resultados.erro === 0) {
                alert('‚úÖ Todos os testes passaram com sucesso!');
            } else {
                alert(`‚ö†Ô∏è ${resultados.erro} teste(s) falharam. Verifique os detalhes.`);
            }
        }

        function limparResultados() {
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`resultado-${i}`).style.display = 'none';
                mostrarStatus(i, 'pending', 'Pendente');
            }
            resultados = { total: 6, sucesso: 0, erro: 0, tempo: 0, detalhes: [] };
            atualizarResumo();
        }

        function exportarResultados() {
            const json = JSON.stringify(resultados, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `teste-juntas-goias-${new Date().toISOString()}.json`;
            a.click();
        }
    </script>
</body>
</html>
